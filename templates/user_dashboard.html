{% extends "base.html" %}

{% block content %}

<div class="navbar-user-layout">
    <span>Logged in as: {{ user }}</span>
    
    <button onclick="showPasswordModal()" style="width: auto; padding: 0 15px; height: 36px; font-size: 0.9rem; background-color: #f39c12;">
        Update Password
    </button>
    
    <button onclick="logout()" style="width: auto; padding: 0 15px; height: 36px; font-size: 0.9rem; background-color: #6c757d;">
        Logout
    </button>
</div>

<h1 style="text-align: center; margin-bottom: 40px; font-weight: 700; color: #1a202c; font-size: 2rem;">
    Doctor's Portal <span style="font-size:1rem; color:#6c757d;">({{ username }})</span>
</h1>

<div class="grid-row-middle">
    <div class="card">
        <h2>My Active Attributes</h2>
        <ul id="key-list" style="list-style:none; padding:10px;">
            <li>Loading keys...</li>
        </ul>
    </div>

    <div class="card">
        <h2>Access EHR Records</h2>
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Available Files</label>
            <select id="file-select" style="margin-bottom:10px;"></select>
        </div>
        <button onclick="downloadSelected()">Decrypt & Download</button>
    </div>
</div>

<div class="grid-row-middle" style="margin-top:30px; grid-template-columns: 1fr;">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>My Access History</h2>
            <button onclick="downloadMyLogs()" style="width:auto; padding:0 20px; background:#28a745; height: 36px; font-size: 0.9rem;">
                Download Excel/CSV
            </button>
        </div>
        
        <div class="table-wrapper">
             <table id="log-table">
                <thead><tr><th>Time</th><th>Action</th><th>Details</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- GLOBAL FLAG TO PREVENT GHOST REQUESTS ---
    window.isFrozenRedirecting = false;

    // --- 1. DATA LOADING ---
    async function loadData() {
        if (window.isFrozenRedirecting) return; // Stop if we are exiting

        try {
            // Load Keys
            const kRes = await fetch('/api/my_keys');
            const keys = await kRes.json();
            document.getElementById('key-list').innerHTML = keys.map(k => 
                `<li style="padding:5px; border-bottom:1px solid #eee;">üîë ${k}</li>`
            ).join('') || '<li>No keys issued yet.</li>';

            // Load Files
            const fRes = await fetch('/api/my_files');
            const files = await fRes.json();
            
            const currentSelection = document.getElementById('file-select').value;
            
            document.getElementById('file-select').innerHTML = files.map(f =>
                `<option value="${f.id}">ID ${f.id}: ${f.filename} [Policy: ${f.policy}]</option>`
            ).join('');
            
            if(currentSelection) {
                document.getElementById('file-select').value = currentSelection;
            }
            
            // Fix: Add timestamp to prevent caching
            const lRes = await fetch('/api/get_logs?ts=' + new Date().getTime()); 
            const logs = await lRes.json();
            
            const tbody = document.querySelector('#log-table tbody');
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No history found.</td></tr>';
            } else {
                tbody.innerHTML = logs.map(l => {
                    const warning = l.is_anomaly 
                        ? "‚ö†Ô∏è <span style='color:red; font-size:0.8rem; font-weight:bold;'>Suspicious Activity Detected</span><br>" 
                        : "";
                    
                    return `<tr>
                        <td>${l.time}</td>
                        <td>${l.action}</td>
                        <td>${warning}${l.details || '-'}</td>
                        <td><span class="status-${l.status}">${l.status}</span></td>
                    </tr>`
                }).join('');
            }
        } catch (e) {
            console.error("Error loading data:", e);
        }
    }

    // --- 2. DOWNLOAD ACTION (FILES) ---
    async function downloadSelected() {
        const fid = document.getElementById('file-select').value;
        if(!fid) return logMessage("No file selected", "error");
        
        logMessage(`Requesting decryption for File ${fid}...`);
        try {
            const res = await fetch(`/api/download_ehr/${fid}`, {method:'POST'});
            
            if(res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'patient_record.enc'; 
                document.body.appendChild(a); a.click(); a.remove();
                logMessage("Decryption SUCCESS. Downloading...", "success");
            } else {
                const d = await res.json();
                
                // --- FIX: DETECT FREEZE AND STOP BACKGROUND REQUESTS ---
                if (d.error && (d.error.includes("Frozen") || d.error.includes("CRITICAL") || d.error.includes("AI Security"))) {
                    window.isFrozenRedirecting = true; // Raise the Flag
                    
                    await Swal.fire({
                        icon: 'error',
                        title: 'ACCOUNT FROZEN',
                        text: 'Security Alert: Your account has been locked due to suspicious activity.',
                        confirmButtonColor: '#d93b3b',
                        allowOutsideClick: false,
                        confirmButtonText: 'Exit System'
                    });
                    window.location.href = '/login'; // Force Redirect
                    return; // Stop execution here
                }
                
                throw new Error(d.error);
            }
        } catch(e) { 
            if (e.message.includes("Frozen") || e.message.includes("CRITICAL")) {
                 window.isFrozenRedirecting = true;
                 window.location.href = '/login';
            } else {
                 logMessage(e.message, "error"); 
            }
        } finally {
            // --- FIX: Only reload data if we are NOT frozen ---
            if (!window.isFrozenRedirecting) {
                setTimeout(loadData, 500);
            }
        }
    }

    // --- 3. PASSWORD POPUP ---
    async function showPasswordModal() {
        const { value: formValues } = await Swal.fire({
            title: 'Update Password',
            width: '400px',
            html: `
                <div style="display: flex; flex-direction: column; gap: 15px; overflow-x: hidden; padding: 0 5px;">
                    <input id="swal-old-pass" class="swal2-input" type="password" placeholder="Current Password" style="font-size:0.9rem; margin: 0; width: 100%; box-sizing: border-box;">
                    <input id="swal-new-pass" class="swal2-input" type="password" placeholder="New Password" style="font-size:0.9rem; margin: 0; width: 100%; box-sizing: border-box;">
                    <input id="swal-confirm-pass" class="swal2-input" type="password" placeholder="Confirm New Password" style="font-size:0.9rem; margin: 0; width: 100%; box-sizing: border-box;">
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Update',
            confirmButtonColor: '#f39c12',
            preConfirm: () => {
                const old_pass = document.getElementById('swal-old-pass').value;
                const new_pass = document.getElementById('swal-new-pass').value;
                const confirm_pass = document.getElementById('swal-confirm-pass').value;

                if (!old_pass || !new_pass || !confirm_pass) {
                    Swal.showValidationMessage('All fields are required');
                    return false;
                }
                if (new_pass !== confirm_pass) {
                    Swal.showValidationMessage('Passwords do not match');
                    return false;
                }
                return [old_pass, new_pass];
            }
        });

        if (formValues) {
            const [old_pass, new_pass] = formValues;
            try {
                const res = await fetch('/api/change_password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ old_password: old_pass, new_password: new_pass })
                });
                const d = await res.json();
                if(res.ok) {
                    Swal.fire('Success', d.message, 'success');
                } else {
                    Swal.fire('Error', d.error, 'error');
                }
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }
    }
    
    function downloadMyLogs() {
        window.location.href = '/api/download_logs?user={{ user }}';
    }
    
    loadData();
</script>
{% endblock %}