{% extends "base.html" %}

{% block content %}

<nav class="navbar">
    <div class="brand">EHR Secure System</div>
    <div class="user-info">
        <span>
            {% if username.lower().startswith('dr') %}
                {{ username }}
            {% else %}
                Dr. {{ username }}
            {% endif %}
            <small>({{ user }})</small>
        </span>
        <button onclick="showPasswordModal()" class="warning" style="padding: 5px 12px; font-size: 0.8rem;">Update Password</button>
        <button onclick="logout()" class="secondary" style="padding: 5px 12px; font-size: 0.8rem;">Logout</button>
    </div>
</nav>

<div class="main-container">

    <div class="grid-2">
        <div class="card">
            <h2>üîë Active Attributes</h2>
            <p>Your digital keys determine which records you can decrypt.</p>
            <ul id="key-list" style="list-style:none; padding:0; display:flex; flex-wrap:wrap; gap:8px;">
                <li>Loading keys...</li>
            </ul>
        </div>

        <div class="card">
            <h2>üìÑ Access EHR Records</h2>
            <p>Decrypt and download patient files.</p>
            <div class="form-group">
                <label>Available Files</label>
                <select id="file-select"></select>
                <small class="helper-text">Select a file to attempt decryption.</small>
            </div>
            <button onclick="downloadSelected()" style="width:100%; justify-content:center;">Decrypt & Download</button>
        </div>
    </div>

    <div class="card full-width">
        <div class="card-header">
            <h2>Access History</h2>
            <button onclick="downloadMyLogs()" class="secondary">Download My Logs</button>
        </div>
        <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
            <table id="log-table">
                <thead><tr><th>Time</th><th>Action</th><th>Notes</th><th>Status</th></tr></thead>
                <tbody><tr><td colspan="4" class="text-center">Loading history...</td></tr></tbody>
            </table>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    window.isFrozenRedirecting = false;

    async function loadData() {
        if (window.isFrozenRedirecting) return;

        try {
            const kRes = await fetch('/api/my_keys');
            if (kRes.status === 403) { window.handleFreeze(); return; }
            const keys = await kRes.json();
            document.getElementById('key-list').innerHTML = keys.map(k => 
                `<li style="background:#e0f2fe; color:#0369a1; padding:4px 10px; border-radius:20px; font-size:0.85rem; font-weight:600;">${k}</li>`
            ).join('') || '<li style="color:#666;">No keys issued yet.</li>';

            const fRes = await fetch('/api/my_files');
            if (fRes.status === 403) { window.handleFreeze(); return; }
            const files = await fRes.json();
            const currentSelection = document.getElementById('file-select').value;
            document.getElementById('file-select').innerHTML = files.map(f =>
                `<option value="${f.id}">ID ${f.id}: ${f.filename} [Policy: ${f.policy}]</option>`
            ).join('');
            if(currentSelection) document.getElementById('file-select').value = currentSelection;
            
            const lRes = await fetch('/api/get_logs?ts=' + new Date().getTime()); 
            if (lRes.status === 403) { window.handleFreeze(); return; }
            const logs = await lRes.json();
            const tbody = document.querySelector('#log-table tbody');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="color:#999;">No history found.</td></tr>';
            } else {
                tbody.innerHTML = logs.map(l => {
                    const warning = l.is_anomaly 
                        ? "<br><small style='color:var(--danger); font-weight:bold;'>‚ö†Ô∏è Suspicious Activity Flag</small>" 
                        : "";
                    const statusClass = l.status === 'SUCCESS' ? 'status-SUCCESS' : 'status-FAILURE';
                    return `<tr>
                        <td>${l.time}</td>
                        <td>${l.action}</td>
                        <td>${l.details || '-'}${warning}</td>
                        <td><span class="${statusClass}">${l.status}</span></td>
                    </tr>`
                }).join('');
            }
        } catch (e) { console.error("Error loading data:", e); }
    }

    async function downloadSelected() {
        const fid = document.getElementById('file-select').value;
        if(!fid) return logMessage("No file selected", "error");
        
        logMessage(`Requesting decryption for File ${fid}...`);
        try {
            const res = await fetch(`/api/download_ehr/${fid}`, {method:'POST'});
            
            if(res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'patient_record.enc'; 
                document.body.appendChild(a); a.click(); a.remove();
                logMessage("Decryption SUCCESS. Downloading...", "success");
            } else {
                const d = await res.json();
                if (d.error && (d.error.includes("Frozen") || d.error.includes("CRITICAL") || d.error.includes("AI Security"))) {
                    window.handleFreeze();
                    return;
                }
                throw new Error(d.error);
            }
        } catch(e) { 
            if (e.message.includes("Frozen") || e.message.includes("CRITICAL")) {
                 window.handleFreeze();
            } else {
                 logMessage(e.message, "error"); 
            }
        } finally {
            if (!window.isFrozenRedirecting) setTimeout(loadData, 500);
        }
    }

    // MODAL: PASSWORD (Compact & Centered)
    async function showPasswordModal() {
        const { value: formValues } = await Swal.fire({
            title: 'Update Password',
            html: `
                <div class="modal-form-group">
                    <label>Current Password</label>
                    <input id="swal-old-pass" class="modal-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="modal-form-group">
                    <label>New Password</label>
                    <input id="swal-new-pass" class="modal-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="modal-form-group">
                    <label>Confirm Password</label>
                    <input id="swal-confirm-pass" class="modal-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Update',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#2563eb', // Primary Blue
            cancelButtonColor: '#6b7280',  // Neutral Gray
            
            preConfirm: () => {
                const old_pass = document.getElementById('swal-old-pass').value;
                const new_pass = document.getElementById('swal-new-pass').value;
                const confirm_pass = document.getElementById('swal-confirm-pass').value;
                if (!old_pass || !new_pass || !confirm_pass) { Swal.showValidationMessage('All fields required'); return false; }
                if (new_pass !== confirm_pass) { Swal.showValidationMessage('Passwords do not match'); return false; }
                return [old_pass, new_pass];
            }
        });

        if (formValues) {
            const [old_pass, new_pass] = formValues;
            try {
                const res = await fetch('/api/change_password', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ old_password: old_pass, new_password: new_pass })
                });
                const d = await res.json();
                if(res.ok) logMessage(d.message, 'success');
                else logMessage(d.error, 'error');
            } catch(e) { logMessage(e.message, 'error'); }
        }
    }
    
    function downloadMyLogs() { window.location.href = '/api/download_logs?user={{ user }}'; }
    loadData();
</script>
{% endblock %}