{% extends "base.html" %}

{% block content %}

<nav class="navbar">
    <div class="brand">EHR Secure System <span style="font-weight:400; font-size:0.9em; color:var(--text-sub);">| Admin Console</span></div>
    <div class="user-info">
        <span>Logged in as: <strong>{{ user }}</strong></span>
        <button onclick="logout()" class="secondary" style="padding: 5px 12px; font-size: 0.8rem;">Logout</button>
    </div>
</nav>

<div class="main-container">

    <div class="card danger-zone">
        <div class="card-header">
            <h2 style="margin:0; border:0; color:var(--danger);">⚠️ Security Alerts & Frozen Accounts</h2>
        </div>
        <p>Monitor accounts flagged by the AI for suspicious behavior.</p>
        <div id="frozen-list" style="min-height: 50px;">
            <span style="color:var(--text-sub); font-style:italic;">Checking security status...</span>
        </div>
        <button onclick="fetchUserStatus()" class="secondary" style="margin-top: 15px;">Refresh Status</button>
    </div>

    <div class="grid-2">
        <div class="card">
            <h2>Register New User</h2>
            <form id="form-register">
                <div class="form-group">
                    <label>User GID (Email)</label>
                    <input type="text" id="reg-gid" placeholder="doctor@hosp.com" required>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="reg-username" placeholder="Dr. Smith" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="reg-password" placeholder="Default: password123">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="reg-role">
                        <option value="user">Doctor / Staff</option>
                        <option value="admin">System Admin</option>
                    </select>
                </div>
                <button type="submit">Create Account</button>
            </form>
        </div>

        <div class="card">
            <h2>Issue Attribute Key</h2>
            <p><small>Grant decryption capabilities.</small></p>
            <form id="form-issue-key">
                <div class="form-group">
                    <label>Target User GID</label>
                    <input type="text" id="key-gid" placeholder="user@hosp.com" required>
                </div>
                <div class="form-group">
                    <label>Authority & Attribute</label>
                    <div style="display:flex; gap:10px;">
                        <select id="key-authority" style="flex:1;">
                            <option value="MA">Medical Authority</option>
                            <option value="HA">Hospital Authority</option>
                        </select>
                        <select id="key-attribute" style="flex:1;"></select>
                    </div>
                </div>
                <button type="submit">Issue Key</button>
            </form>

            <hr style="margin: 2rem 0; border:0; border-top:1px solid var(--border);">

            <h2 style="color:var(--danger); border:0;">Revoke Access</h2>
            <form id="form-revoke">
                <div class="form-group">
                    <label>Target User GID</label>
                    <input type="text" id="revoke-gid" placeholder="user@hosp.com" required>
                </div>
                <div class="form-group">
                    <div style="display:flex; gap:10px;">
                        <select id="revoke-authority" style="flex:1;">
                            <option value="MA">Medical Authority</option>
                            <option value="HA">Hospital Authority</option>
                        </select>
                        <select id="revoke-attribute" style="flex:1;"></select>
                    </div>
                </div>
                <button type="submit" class="danger">Revoke Key</button>
            </form>
        </div>
    </div>

    <div class="card">
        <h2>Upload & Encrypt EHR</h2>
        <form id="form-upload">
            <div class="form-group">
                <label>Select Patient Record (.txt only)</label>
                <input type="file" id="upload-file" accept=".txt">
            </div>
            <div class="form-group">
                <label>Define Access Policy</label>
                <div class="permission-box">
                    <strong style="color:var(--primary); font-size:0.85rem;">Medical Authority (MA)</strong>
                    <div id="ma-checks" class="checkbox-grid"></div>
                    <hr style="margin:10px 0; border:0; border-top:1px solid #e2e8f0;">
                    <strong style="color:var(--primary); font-size:0.85rem;">Hospital Authority (HA)</strong>
                    <div id="ha-checks" class="checkbox-grid"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Logic Operator</label>
                <div style="display: flex; gap: 20px;">
                    <label><input type="radio" name="logic" value="OR" checked onchange="buildPolicy()"> <strong>OR</strong></label>
                    <label><input type="radio" name="logic" value="AND" onchange="buildPolicy()"> <strong>AND</strong></label>
                </div>
            </div>
            <div class="form-group">
                <label>Generated Policy String</label>
                <input type="text" id="upload-policy" readonly style="background:#f3f4f6; color:var(--text-sub);">
            </div>
            <button type="submit" style="background-color: #059669;">Encrypt & Upload Record</button>
        </form>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>System Audit Logs (AI Enhanced)</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="log-filter-user" placeholder="Filter by User..." style="width:200px; margin:0;">
                <button onclick="fetchLogs()" style="background-color: var(--primary); color:white;">Search</button>
                <button onclick="downloadLogs()">Download CSV</button>
            </div>
        </div>
        <div class="table-wrapper" style="max-height: 400px; overflow-y:auto;">
            <table id="log-table">
                <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Status</th><th>Risk?</th><th>Details</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>File Registry (ID Map)</h2>
        <div class="table-wrapper" style="max-height: 250px; overflow-y:auto;">
            <table id="file-registry-table">
                <thead><tr><th style="width: 80px;">ID</th><th>Filename</th><th>Access Policy</th><th style="width:100px;">Actions</th></tr></thead>
                <tbody><tr><td colspan="4">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    // --- DROPDOWNS & CHECKBOXES ---
    const ATTRIBUTES = {
        "MA": ["DOCTOR", "NURSE", "RESEARCHER", "CARDIOLOGY", "ONCOLOGY", "SURGERY"],
        "HA": ["STAFF", "NOSTAFF", "CARDIO_DEPT", "ONCO_DEPT", "EMERGENCY", "GEN_HOSP"]
    };

    function populateDropdown(authId, attrId) {
        const auth = document.getElementById(authId).value;
        const sel = document.getElementById(attrId); sel.innerHTML = '';
        ATTRIBUTES[auth].forEach(a => sel.innerHTML += `<option value="${a}">${a}</option>`);
    }

    document.getElementById('key-authority').addEventListener('change', () => populateDropdown('key-authority', 'key-attribute'));
    document.getElementById('revoke-authority').addEventListener('change', () => populateDropdown('revoke-authority', 'revoke-attribute'));
    populateDropdown('key-authority', 'key-attribute');
    populateDropdown('revoke-authority', 'revoke-attribute');

    function initCheckboxes() {
        const maDiv = document.getElementById('ma-checks');
        const haDiv = document.getElementById('ha-checks');
        ATTRIBUTES['MA'].forEach(a => maDiv.innerHTML += `<label><input type="checkbox" value="MA_${a}" onchange="buildPolicy()"> ${a}</label>`);
        ATTRIBUTES['HA'].forEach(a => haDiv.innerHTML += `<label><input type="checkbox" value="HA_${a}" onchange="buildPolicy()"> ${a}</label>`);
    }
    initCheckboxes();
    
    function buildPolicy() {
        const checkboxes = document.querySelectorAll('#ma-checks input:checked, #ha-checks input:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);
        const logic = document.querySelector('input[name="logic"]:checked').value;
        const joiner = logic === 'OR' ? ' or ' : ' and ';
        document.getElementById('upload-policy').value = selected.length > 0 ? (selected.length===1 ? selected[0] : "(" + selected.join(joiner) + ")") : "";
    }

    // --- FROZEN USERS ---
    async function fetchUserStatus() {
        try {
            const res = await fetch('/api/get_users_status');
            const users = await res.json();
            const container = document.getElementById('frozen-list');
            const frozenUsers = users.filter(u => u.is_frozen);
            
            if (frozenUsers.length === 0) {
                container.innerHTML = '<div style="padding:10px; color:var(--status-success-text); background:var(--status-success-bg); border-radius:4px; font-weight:500;">✅ System Healthy. No frozen accounts.</div>';
            } else {
                container.innerHTML = frozenUsers.map(u => `
                    <div class="frozen-item">
                        <span><strong>${u.gid}</strong> <small style="color:#666;">(Frozen)</small></span> 
                        <button onclick="unfreezeUser('${u.gid}')" class="secondary" style="font-size:0.75rem; border-color:var(--status-success-text); color:var(--status-success-text);">Reactivate</button>
                    </div>
                `).join('');
            }
        } catch(e) { console.error(e); }
    }

    // MODAL: UNFREEZE (Buttons centered by CSS)
    async function unfreezeUser(gid) {
        const result = await Swal.fire({
            title: 'Reactivate Account',
            html: `Are you sure you want to unfreeze <strong>${gid}</strong>?<br><small style="color:#666;">This will restore immediate access.</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#059669',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Reactivate',
            cancelButtonText: 'Cancel'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch('/api/unfreeze_user', {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({gid})
            });
            const d = await res.json();
            if(res.ok) { 
                logMessage(d.message, 'success'); 
                fetchUserStatus(); 
                fetchLogs(); 
            } else { 
                Swal.fire('Error', d.error, 'error'); 
            }
        } catch(e) { logMessage(e.message, 'error'); }
    }

    document.getElementById('form-register').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gid = document.getElementById('reg-gid').value;
        const username = document.getElementById('reg-username').value;
        const password = document.getElementById('reg-password').value;
        const role = document.getElementById('reg-role').value;
        try {
            const res = await fetch('/api/register_user', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({gid, username, password, role})});
            const d = await res.json();
            if(res.ok) { logMessage(d.message, 'success'); fetchUserStatus(); fetchLogs(); }
            else { logMessage(d.error, 'error'); }
        } catch(e) { logMessage(e.message, 'error'); }
    });

    document.getElementById('form-issue-key').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gid = document.getElementById('key-gid').value;
        const auth = document.getElementById('key-authority').value;
        const attr = document.getElementById('key-attribute').value;
        try {
            const res = await fetch('/api/issue_key', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({gid, authority_id:auth, attribute:attr})});
            const d = await res.json();
            if(res.ok) { logMessage(d.message, 'success'); fetchLogs(); } 
            else { logMessage(d.error, 'error'); }
        } catch(e) { logMessage(e.message, 'error'); }
    });

    document.getElementById('form-revoke').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gid = document.getElementById('revoke-gid').value;
        const auth = document.getElementById('revoke-authority').value;
        const attr = document.getElementById('revoke-attribute').value;
        try {
            const res = await fetch('/api/revoke_key', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({gid, authority_id:auth, attribute:attr})});
            const d = await res.json();
            if(res.ok) { logMessage(d.message, 'success'); fetchLogs(); } 
            else { logMessage(d.error, 'error'); }
        } catch(e) { logMessage(e.message, 'error'); }
    });

    document.getElementById('form-upload').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileIn = document.getElementById('upload-file');
        const policy = document.getElementById('upload-policy').value;
        if(!fileIn.files[0]) return logMessage("Select a file", "error");
        if(!policy) return logMessage("Select permissions", "error");

        const fd = new FormData();
        fd.append('file', fileIn.files[0]);
        fd.append('filename', fileIn.files[0].name);
        fd.append('policy', policy);
        
        logMessage("Encrypting & Uploading...");
        try {
            const res = await fetch('/api/upload_ehr', {method:'POST', body:fd});
            const d = await res.json();
            if(res.ok) { logMessage("Uploaded successfully. ID: " + d.file_id, 'success'); fetchLogs(); fetchFileRegistry(); }
            else { logMessage(d.error, 'error'); }
        } catch(e) { logMessage(e.message, 'error'); }
    });

    async function fetchFileRegistry() {
        try {
            const res = await fetch('/api/get_all_files');
            const files = await res.json();
            const tbody = document.querySelector('#file-registry-table tbody');
            if(files.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No files uploaded.</td></tr>'; return; }
            tbody.innerHTML = files.map(f => `
                <tr>
                    <td style="font-weight:bold;">${f.id}</td>
                    <td>${f.filename}</td>
                    <td><code style="background:#f3f4f6; padding:2px 5px; border-radius:3px;">${f.policy}</code></td>
                    <td><button class="danger" onclick="deleteFile('${f.id}')" style="padding:4px 8px; font-size:0.75rem;">Delete</button></td>
                </tr>
            `).join('');
        } catch(e) { console.error(e); }
    }

    // MODAL: DELETE (Buttons centered by CSS)
    async function deleteFile(fid) {
        const result = await Swal.fire({
            title: 'Delete File?',
            html: `Delete File <strong>${fid}</strong> permanently?<br><small style="color:#d33;">This action cannot be undone.</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Delete',
            cancelButtonText: 'Cancel'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch('/api/delete_file', {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({file_id: fid})
            });
            const d = await res.json();
            if(res.ok) { 
                logMessage(d.message, 'success'); 
                fetchFileRegistry(); 
                fetchLogs(); 
            }
            else { 
                logMessage(d.error, 'error'); 
            }
        } catch(e) { logMessage(e.message, 'error'); }
    }

    async function fetchLogs() {
        try {
            const filter = document.getElementById('log-filter-user').value;
            const url = filter ? `/api/get_logs?user=${filter}` : '/api/get_logs';
            const res = await fetch(url);
            const logs = await res.json();
            const tbody = document.querySelector('#log-table tbody');
            if(logs.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No logs found.</td></tr>'; return; }
            tbody.innerHTML = logs.map(l => {
                const riskStyle = l.is_anomaly ? "background-color:var(--status-fail-bg); color:var(--status-fail-text);" : "";
                const riskIcon = l.is_anomaly ? "⚠️ YES" : "<span style='color:#ccc'>-</span>";
                return `<tr style="${riskStyle}"><td>${l.time}</td><td>${l.user}</td><td>${l.action}</td><td>${l.status}</td><td>${riskIcon}</td><td>${l.details}</td></tr>`;
            }).join('');
        } catch(e) { console.error(e); }
    }

    function downloadLogs() {
        const filter = document.getElementById('log-filter-user').value;
        const url = filter ? `/api/download_logs?user=${filter}` : '/api/download_logs';
        window.location.href = url;
    }

    fetchLogs();
    fetchFileRegistry();
    fetchUserStatus();
    setInterval(fetchUserStatus, 5000); 
</script>
{% endblock %}