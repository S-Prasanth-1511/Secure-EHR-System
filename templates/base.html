<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Secure System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='ehr_ui.css') }}">
</head>
<body>
    
    <div id="message-container"></div>

    {% block content %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Global Helper: Show Messages (Small Toast)
        function logMessage(msg, type='info') {
            console.log(`[${type.toUpperCase()}] ${msg}`);
            const Toast = Swal.mixin({
                toast: true, 
                position: 'top-end', 
                showConfirmButton: false, 
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
            });
            Toast.fire({ icon: type, title: msg });
        }
        
        async function logout() {
            await fetch('/api/logout', {method:'POST'});
            window.location.href = '/login';
        }

        // --- GLOBAL FREEZE HANDLER ---
        window.isFrozenRedirecting = false;
        
        window.handleFreeze = async function() {
            if (window.isFrozenRedirecting) return;
            window.isFrozenRedirecting = true;
            
            // Buttons will be centered by CSS
            await Swal.fire({
                icon: 'error',
                title: 'Session Terminated',
                text: 'Your account is temporarily frozen due to suspicious activity.',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: true,
                confirmButtonText: 'Log Out',
                confirmButtonColor: '#d93b3b'
            });
            window.location.href = '/login';
        };

        // --- SECURITY HEARTBEAT ---
        setInterval(async () => {
            if (window.location.pathname === '/login' || window.location.pathname === '/') return;
            try {
                const res = await fetch('/api/heartbeat');
                const data = await res.json();
                
                if (res.status === 403 || data.status === 'frozen') {
                    window.handleFreeze();
                }
            } catch (e) { 
                console.log("Heartbeat skipped:", e); 
            }
        }, 1000); 
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>